---
title: "SuRGE Field Duplicates and Field Blanks"
author: "J. Beaulieu and J. Corra"
date: "3/17/2022"
output: pdf_document
---

```{r setup, results='hide', message=FALSE, warning=FALSE, echo=FALSE}

# Identify local path for each user
userPath <- paste0(Sys.getenv("USERPROFILE"), 
                   "/Environmental Protection Agency (EPA)/",
                   "SuRGE Survey of Reservoir Greenhouse gas Emissions - Documents/")

# R proj folder at SP.
localName <- if (grepl("JBEAULIE", userPath)) {
"Jake/"
} else if (grepl("JCOR", userPath)) {
"Joe/"} 

# load project libraries
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/masterLibrary.R"))

# load data
# Analysis
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readSurgeLakes.R")) # read in survey design file
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/chemSampleList.R")) # creates chem.samples.foo, an inventory of all collected chem sample


# Read chemistry
# uncomment rows to bring in more data
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readFieldSheets.R")) # read surgeData...xlsx.  fld_sheet, dg_sheet
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readAnionsAda.R")) # read ADA lab anions
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readAnionsDaniels.R")) # read Kit Daniels anions
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readNutrientsAda.R")) # read nutrients ran in ADA lab
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readNutrientsAwberc.R")) # read AWBERC lab nutrient results
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readNutrientsR10_2018.R")) # read AWBERC nutrients for 2018 R10
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readOcAda.R")) # read ADA TOC/DOC data
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readOcMasi.R")) # read 2020 TOC run at MASI lab
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readTteb.R")) # TTEB metals, TOC, DOC
# source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readPigmentsMicrocystin.R")) # NAR chl, phyco, and microcystin
# source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readTaxonomy.R")) # GB taxonomy
source(paste0(userPath, "rProjects/", localName, "SuRGE/scripts/analysis/readChlorophyllR10_2018.R")) # 2018 R10 chlorophyll

source(paste0(userPath, "rProjects/", localName,
  "SuRGE/scripts/analysis/mergeChemistry.R")) # merge all chem objects #chemistry all
```

## Background

SuRGE (Survey of Reservoir Greenhouse gas Emissions) is an national-scale survey of methane (CH~4~) and carbon dioxide (CO~2~) emissions from US reservoirs.  Gas emissions are measured at >= 15 locations within each reservoir.  Water chemistry samples are collected from two depths (near the air-water interface and the sediment-water interface) at one location within each reservoir.  At a subset of the reservoirs, field blanks and field duplicates are also collected.  This report details results from the field blanks and duplicates.

## Executive Summary
Agreement among unknowns and field replicates was acceptable across the full suite of analytes that are important to SuRGE.  Field blanks were occasionally high for ammonium (nh4), dissolved reactive phosphorus (oP), total nitrogen (TN), and total phosphorus (TP).  The following corrective actions are recommended:
  
* deionized water used for field blanks should have a resistivity >= 18 Mohms.
* the vessel used to transport deionized water into the field should be washed with laboratory grade detergent, soaked in an acid bath, and thoroughly rinsed with deionized prior between uses.
* filters should be flushed with a minimum of 30mL of sample water prior to collecting a sample.
* sample bottles should be rinsed with sample water a minimum of three times prior to collecting a sample.
* analysts should wear laboratory grade gloves during sample collection.



## Detection Limits

Detection limits vary by analyte, analytical method, lab, and possibly by year.  See `Analytical` section of Wiki for details.

```{r echo=FALSE, message=FALSE, warning=FALSE}

detlimits <- read_xls(path = paste0(userPath,"data/chemistry/detectionLimits.xls"))

```

## Field Blanks

### ADA Anions
Fluoride and bromide were below the detection limit for all field blanks from ADA.  Chloride and sulfate were about 3-fold greater than the detection limit in field blanks from lake 148, but were still 4-5 orders of magnitude lower than the unknowns from that lake.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=11}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
ada.anions %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),3),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(anion = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, anion, mdl, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, # nice formatting
                  caption = "Minimum and Maximum Anion Concentrations Measured at ADA") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", " ", "Unknowns" = 2)) %>% # header above the unknowns
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "top")


ada.anions %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank()) + # remove legend titles
  labs(title = "ADA Anion Samples",
       x =NULL, y = "mg/L") + 
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

\newpage

### CIN Anions
Anion samples collected in 2020 by field crews other than ADA were analyzed at EPA Cincinnati.  All bromide blanks were below the detection limit, as where most of the unknowns.  Most chloride blanks were below the detection limit and all were several orders of magnitude below the unknowns.  Lake 233 had a high F blank, but all others were at DL.  Sulfate blanks were near the detection limit and several orders of magnitude below the unknowns.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=11}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
d.anions %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),3),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(anion = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, anion, mdl, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum Anion Concentrations Measured at CIN") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", " ", "Unknowns" = 2)) %>% # header above the unknowns
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "top") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))


d.anions %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "CIN Anion Samples",
       x =NULL, y = "mg/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

\newpage

### Nutrients 2018
Nutrient samples were collected at 8 lakes by Region 10 in 2018 and were analyzed via Lachat in CIN. A field blank was collected at one lake.  Analyte concentrations were at or near the mdl for the field blank.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=11}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
chem18 %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),3),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "CIN" & year == "2018"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(nutrient = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, nutrient, mdl, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum Nutrient Concentrations Measured in 2018 Samples Analyzed at CIN") %>% # table title
    kableExtra::add_header_above(c(" ", " ", " ", " ", "Unknowns" = 2)) %>% # header above the unknowns
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "top") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))


chem18 %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN" & year == "2018"), by = "name") %>%
  filter(name %in% c("nh4", "no2", "no2_3", "no3", "tn")) %>% # plot n only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2018 Nutrients Analyzed at CIN",
     x =NULL, y = "μg n/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=6}

chem18 %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN" & year == "2018"), by = "name") %>%
  filter(name %in% c("tp", "op")) %>% # plot p only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2018 Nutrients Analyzed at CIN",
     x =NULL, y = "μg p/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

\newpage

### Nutrients ADA
The ADA General Parameters Laboratory analyzed SuRGE nutrient sample collected by the CIN field crew during the 2020 sampling season.  These samples were frozen after collection and stored until the laboratory reopened following the COVID shutdown.  The ADA General Parameters Laboratory also analyzed 2021 SuRGE samples collected by ADA field crew.

All TN blanks, with the exception of lake 191, were at the MDL.  TP blanks were generally greater than the MDL and lower than the unknowns; but TP blanks at lakes 191 and 235 were of similar magnitude as the unknowns.  NH4 blanks were generally 2-5 fold greater than the MDL and of similar magnitude as the unknowns in some lakes. NO2.3 blanks were at the MDL in 8 out of 12 lakes.  op field blanks exceeded the MDL in all but one lake.



```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=11}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
ada.nutrients %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  select(-no3) %>% # not needed for now
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),2),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(nutrient = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, nutrient, mdl, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum Nutrient Concentrations Measured at ADA") %>% # table title
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "bottom") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))


ada.nutrients %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  select(-no3) %>% # not needed for now
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  filter(name %in% c("nh4", "no2", "no2_3", "no3", "tn")) %>% # plot n only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2021 Nutrients Analyzed at ADA",
       x =NULL, y = "μg n/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=6}

ada.nutrients %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  select(-no3) %>% # not needed for now
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  filter(name %in% c("tp", "op")) %>% # plot p only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2021 Nutrients Analyzed at ADA",
       x =NULL, y = "μg p/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

\newpage

### Nutrients AWBERC
2021 SuRGE samples collected by field crews other than ADA were analyzed in CIN. TP and TN blanks were often greater than the MDL, but NH4, NO2, and NO2.3 field blanks were generally at, or just slightly elevated above the MDL.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=11}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
chem21 %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),2),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "CIN" & year == "2021"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(nutrient = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, nutrient, mdl, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum Nutrient Concentrations Measured in 2021 SuRGE Samples Analyzed at CIN") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", " ", "Unknowns" = 2)) %>% # header above the unknowns
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "bottom") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))


chem21 %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN" & year == "2021"), by = "name") %>%
  filter(name %in% c("nh4", "no2", "no2_3", "no3", "tn")) %>% # plot n only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2021 Nutrients Analyzed at AWBERC",
       x =NULL, y = "μg n/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=6}
chem21 %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN" & year == "2021"), by = "name") %>%
  filter(name %in% c("tp", "op")) %>% # plot p only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  scale_y_log10() +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank(),  # remove legend titles
          axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2021 Nutrients Analyzed at AWBERC",
       x =NULL, y = "μg p/L") +
  facet_wrap(~name, scales = "free") +
  theme(legend.position = "bottom")

```

\newpage

### Metals
Text about metals placeholder.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=11}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
tteb.all %>%
  ungroup() %>%
  select(-shipping_notes, -contains("tteb")) %>% # remove tteb TOC and DOC
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),3),  max = round(max(value),3)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  mutate(mdl = round(mdl, 3)) %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(metal = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, metal, mdl, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum Metals Concentrations in Unknowns") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", " ", "Unknowns" = 2)) %>% # header above the unknowns
  kableExtra::column_spec(1, bold = TRUE) %>%
  kableExtra::collapse_rows(columns = 1, valign = "bottom") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))


tteb.all %>% ungroup() %>%
  select(-shipping_notes, -contains("tteb")) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  filter(name < "fe") %>% # plot al:cu only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank()) + # remove legend titles
   labs(title = "Metals field blanks",
        x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~name, scales = "free", ncol = 2, nrow = 4) +
  theme(legend.position = "bottom")

```

\newpage

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=11}

tteb.all %>% ungroup() %>%
  select(-shipping_notes) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  filter(name > "cu" & name < "pb") %>% # plot fe:p only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank()) + # remove legend titles
  labs(title = "Metals field blanks",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~name, scales = "free", ncol = 2, nrow = 4) +
  theme(legend.position = "bottom")


```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=11}

tteb.all %>% ungroup() %>%
  select(-shipping_notes) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  filter(name > "p") %>% # plot pb:zn only
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank()) + # remove legend titles
  labs(title = "Metals field blanks",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_wrap(~name, scales = "free", ncol = 2, nrow = 5) +
  theme(legend.position = "bottom")


```

\newpage

### Organic Carbon MASI
During the 2020 field season, TOC samples were analyzed at MASI, an external contract laboratory.  All field blanks were at the detection limit.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
toc.masi %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),2),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(analyte = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, analyte, mdl, blank, minimum, maximum) %>%
  mutate(mdl = sprintf("%.2f", mdl)) %>% # add trailing zero
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum TOC Concentrations in Unknowns") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", "Unknowns" = 2)) # header above the unknowns


toc.masi %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank()) + # remove legend titles
  labs(title = "TOC field blanks",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90))

```

\newpage

### Organic Carbon ADA
Dissolved and total organic carbon samples (oc) collected by the ADA field crew were analyzed at ADA's General Parameters Laboraotry.  Field blanks had oc concentrations that were 2 to 6 times greater than the mdl, but an order of magnitude less than the unknowns. 

```{r echo=FALSE, message=FALSE, warning=FALSE}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
ada.oc %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),2),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  select(-lab, -year, -units, -analyte_group) %>%
  rename(analyte = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown) %>%
  relocate(lake_id, analyte, mdl, blank, minimum, maximum) %>%
  mutate(mdl = sprintf("%.2f", mdl)) %>% # add trailing zero
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum TOC Concentrations in Unknowns") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", "Unknowns" = 2)) # header above the unknowns


ada.oc %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "ADA"), by = "name") %>%
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  geom_hline(aes(yintercept=mdl, linetype = "minimum detection limit"),
             color = "red") + # add horizontal lines for det. limits
  theme(legend.title = element_blank()) + # remove legend titles
  labs(title = "TOC field blanks",
       x =NULL, y = "mg/L") +
  facet_wrap(~name, scales = "free")

```

\newpage

### Chlorophyll a: CIN and BSA 
Chlorophyll a samples collected by Region 10 in 2018 were extracted in CIN.  Some of the extracts were analyzed in CIN and the balance were analyzed by BSA, an outside contract laboratory.  Defining a mdl for chlorophyll is difficult because it is dependent upon the sample volume filtered.  Below we report the values of the field blank and unknowns.  

```{r echo=FALSE, message=FALSE, warning=FALSE}


# table
# formatting guide https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_pdf.pdf
chl18 %>%
  ungroup() %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  pivot_longer(!c(lake_id, sample_type)) %>%
  group_by(lake_id, name, sample_type) %>%
  summarize(min = round(min(value),2),  max = round(max(value),2)) %>%
  pivot_wider(names_from = sample_type, values_from = c(min, max)) %>%
  filter(is.na(min_blank) == FALSE) %>%
  select(-max_blank) %>%
  rename(analyte = name, blank = min_blank, minimum = min_unknown, maximum = max_unknown)  %>%
  relocate(lake_id, analyte, blank, minimum, maximum) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Minimum and Maximum Chlorophyll-A Concentrations in Unknowns") %>% # table title
  kableExtra::add_header_above(c(" ", " ", " ", "Unknowns" = 2))# %>% # header above the unknowns


chl18 %>% ungroup() %>%
  select(!c(site_id, sample_depth), -matches("flag|qual|units")) %>%
  mutate(sample_type = case_when(sample_type == "duplicate" ~ "unknown", TRUE ~ sample_type)) %>%
  pivot_longer(cols = !c(lake_id, sample_type)) %>%
  left_join(y = filter(detlimits, lab == "CIN"), by = "name") %>%
  ggplot() +
  aes(lake_id, value) +
  geom_point(aes(color = sample_type)) +
  theme(legend.title = element_blank()) + # remove legend titles
  ggtitle("Chlorophyll-A field blanks") +
  labs(title = "Chlorophyll-A field blanks",
       x =NULL, y = NULL) +
  facet_wrap(~name, scales = "free")

```

\newpage

### Chlorophyll a: Naragansett
Placeholder for chlorophyll data from Narragansett.

## Field duplicates
Field duplicates were collected at a subset of SuRGE lakes.
```{r echo=FALSE, message=FALSE, warning=FALSE}
#set up for below

# identify lakes, sites, and depths with duplicates
duplicate_ids <- chemistry_all %>% filter(sample_type == "duplicate") %>%
  select(lake_id, site_id, sample_depth) %>%
  mutate(id = paste0(lake_id, site_id, sample_depth))

# pull out data from lakes, sites, and depths with duplicates
chemistry_all_dups <- chemistry_all %>% 
  mutate(id = paste0(lake_id, site_id, sample_depth)) %>% # create unique id
  filter(id %in% duplicate_ids$id) %>% # pull out duplicates and corresponding unknowns
  select(-contains("flag"), -contains("qual"), -contains("units"), 
         -sample_type, -id, -shipping_notes, -no3) %>%
  pivot_longer(!c(lake_id, site_id, sample_depth))



```


### Nutrients
```{r echo=FALSE, message=FALSE, warning=FALSE}
# set up for below

# vector of nutrient names
nutrient_name <- detlimits %>% 
  filter(analyte_group == "nutrients") %>%
  select(name) %>% 
  pull()

# calculate mean relative percent difference among field replicates
nutrients_rpd <- chemistry_all_dups %>% 
  filter(name %in% nutrient_name) %>%
  group_by(lake_id, site_id, sample_depth, name) %>%
  mutate(difference = abs(diff(value)), # difference between dup and unknown
         mean = mean(value), # mean of dup and unknown
         rpd = (difference/mean)*100) %>% # rpd
    distinct() %>%
  group_by(name) %>%
  summarize(rpd = mean(rpd, na.rm = TRUE))


```
Relative percent agreement among nutrient duplicates was greatest for `r nutrients_rpd %>% filter(rpd == max(rpd)) %>% select(name) %>% pull()`(`r nutrients_rpd %>% filter(rpd == max(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%) and lowest for `r nutrients_rpd %>% filter(rpd == min(rpd)) %>% select(name) %>% pull()`(`r nutrients_rpd %>% filter(rpd == min(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%).


```{r echo=FALSE, message=FALSE, warning=FALSE}
nutrients_rpd %>%
  mutate(rpd = round(rpd, 1)) %>%
  rename(Analyte = name, `Relative Percent Difference` = rpd) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Mean relative percent difference among unknowns and field duplicates") 
      
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=8}
ggplot(chemistry_all_dups %>% 
         filter(name %in% nutrient_name) %>%
         filter(name %in% c("nh4", "no2", "no2_3", "no3", "tn")) %>% # plot n only
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: nutrients",
       x =NULL, y = "μg n/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=6}
ggplot(chemistry_all_dups %>% 
         filter(name %in% nutrient_name) %>%
         filter(name %in% c("tp", "op")) %>% # plot n only
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: nutrients",
       x =NULL, y = "μg p/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 


```

\newpage

### Anions

```{r echo=FALSE, message=FALSE, warning=FALSE}
# vector of anion names
anion_name <- detlimits %>% 
  filter(analyte_group == "anions") %>%
  select(name) %>% 
  pull()

# calculate mean relative percent difference among field replicates
anions_rpd <- chemistry_all_dups %>% 
  filter(name %in% anion_name) %>%
  group_by(lake_id, site_id, sample_depth, name) %>%
  mutate(difference = abs(diff(value)), # difference between dup and unknown
         mean = mean(value), # mean of dup and unknown
         rpd = (difference/mean)*100) %>% # rpd
    distinct() %>%
  group_by(name) %>%
  summarize(rpd = mean(rpd, na.rm = TRUE))

```

Relative percent agreement among anion duplicates was greatest for `r anions_rpd %>% filter(rpd == max(rpd)) %>% select(name) %>% pull()` (`r anions_rpd %>% filter(rpd == max(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%) and lowest for `r anions_rpd %>% filter(rpd == min(rpd)) %>% select(name) %>% pull()` (`r anions_rpd %>% filter(rpd == min(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%).

```{r echo=FALSE, message=FALSE, warning=FALSE}
anions_rpd %>%
  mutate(rpd = round(rpd, 1)) %>%
  rename(Analyte = name, `Relative Percent Difference` = rpd) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Mean relative percent difference among unknowns and field duplicates") 
      
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=8}
ggplot(chemistry_all_dups %>% 
         filter(name %in% anion_name) %>%
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: anions",
       x =NULL, y = "mg/L") +
  facet_wrap(~name, scales = "free") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

\newpage

### Metals

```{r echo=FALSE, message=FALSE, warning=FALSE}
# vector of anion names
metal_name <- detlimits %>% 
  filter(analyte_group == "metals") %>%
  select(name) %>% 
  pull()

# calculate mean relative percent difference among field replicates
metals_rpd <- chemistry_all_dups %>% 
  filter(name %in% metal_name) %>%
  group_by(lake_id, site_id, sample_depth, name) %>%
  mutate(difference = abs(diff(value)), # difference between dup and unknown
         mean = mean(value), # mean of dup and unknown
         rpd = (difference/mean)*100) %>% # rpd
    distinct() %>%
  group_by(name) %>%
  summarize(rpd = mean(rpd, na.rm = TRUE))

```

Relative percent agreement among METALS duplicates was greatest for `r metals_rpd %>% filter(rpd == max(rpd)) %>% select(name) %>% pull()` (`r metals_rpd %>% filter(rpd == max(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%) and lowest for `r metals_rpd %>% filter(rpd == min(rpd)) %>% select(name) %>% pull()` (`r metals_rpd %>% filter(rpd == min(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%).  Although the analysis quantifies many analytes, calcium and magnesium are the most relevant for SuRGE.  The relative percent agreement for those two analytes was quite good.

```{r echo=FALSE, message=FALSE, warning=FALSE}
metals_rpd %>%
  mutate(rpd = round(rpd, 1)) %>%
  rename(Analyte = name, `Relative Percent Difference` = rpd) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Mean relative percent difference among unknowns and field duplicates") 
      
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=11}
ggplot(chemistry_all_dups %>% 
         filter(name %in% metal_name) %>%
         filter(name < "fe") %>%
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: metals",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=11}
ggplot(chemistry_all_dups %>% 
         filter(name %in% metal_name) %>%
         filter(name > "cu" & name < "pb") %>%
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: metals",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8.5, fig.height=11}
ggplot(chemistry_all_dups %>% 
         filter(name %in% metal_name) %>%
         filter(name > "p") %>%
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: metals",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

\newpage

### OC

<!-- ### Organic Carbon -->

```{r echo=FALSE, message=FALSE, warning=FALSE}
# vector of anion names
organic_name <- detlimits %>% 
  filter(analyte_group == "organic") %>%
  select(name) %>% 
  pull()

# calculate mean relative percent difference among field replicates
organic_rpd <- chemistry_all_dups %>% 
  filter(name %in% organic_name) %>%
  group_by(lake_id, site_id, sample_depth, name) %>%
  mutate(difference = abs(diff(value)), # difference between dup and unknown
         mean = mean(value), # mean of dup and unknown
         rpd = (difference/mean)*100) %>% # rpd
    distinct() %>%
  group_by(name) %>%
  summarize(rpd = mean(rpd, na.rm = TRUE))

```

Relative percent agreement among organic carbon duplicates was greatest for `r organic_rpd %>% filter(rpd == max(rpd)) %>% select(name) %>% pull()` (`r organic_rpd %>% filter(rpd == max(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%) and lowest for `r organic_rpd %>% filter(rpd == min(rpd)) %>% select(name) %>% pull()` (`r organic_rpd %>% filter(rpd == min(rpd)) %>% select(rpd) %>% pull() %>% round(.,1)`%).

```{r echo=FALSE, message=FALSE, warning=FALSE}
organic_rpd %>%
  mutate(rpd = round(rpd, 1)) %>%
  rename(Analyte = name, `Relative Percent Difference` = rpd) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Mean relative percent difference among unknowns and field duplicates") 
      
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(chemistry_all_dups %>% 
         filter(name %in% organic_name) %>%
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: OC",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```


\newpage

### Algal pigments

Placeholder text.
```{r echo=FALSE, message=FALSE, warning=FALSE}

# calculate mean relative percent difference among field replicates
chlorophyll_rpd <- chemistry_all_dups %>% 
  filter(name == "chla") %>%
  group_by(lake_id, site_id, sample_depth, name) %>%
  mutate(difference = abs(diff(value)), # difference between dup and unknown
         mean = mean(value), # mean of dup and unknown
         rpd = (difference/mean)*100) %>% # rpd
    distinct() %>%
  group_by(name) %>%
  summarize(rpd = mean(rpd, na.rm = TRUE))

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
chlorophyll_rpd %>%
  mutate(rpd = round(rpd, 1)) %>%
  rename(Analyte = name, `Relative Percent Difference` = rpd) %>%
  kableExtra::kbl(booktabs = TRUE, longtable = TRUE, # nice formatting
                  caption = "Mean relative percent difference among unknowns and field duplicates") 
      
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(chemistry_all_dups %>% 
         filter(name == "chla") %>%
         mutate, 
       aes(lake_id, value)) +
  geom_point() +
  facet_wrap(~name, scales = "free") +
  labs(title = "Concentrations of Field Duplicates and Paired Unknowns: chlorophyll",
       x =NULL, y = "mg/L") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```








